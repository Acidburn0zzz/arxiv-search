{% macro size_and_order(form, action_uri) %}
<div class="level breathe-horizontal">
  <div class="level-left">
    <form method="GET" action="{{ action_uri }}">
      <div style="display: none;">
        {% for field in form %}
          {% if field != form.size and field != form.order %}
            {{ field }}
          {% endif %}
        {% endfor %}
      </div>
      <div class="box field is-grouped is-grouped-multiline level-item">
        <div class="control">
          <span class="select is-small">
            {{ form.size|safe }}
          </span>
          {{ form.size.label }}.
        </div>
        <div class="control">
          {{ form.order.label }}
          <span class="select is-small">
            {{ form.order|safe }}
          </span>
        </div>
        <div class="control">
          <button class="button is-small is-link">Go</button>
        </div>
      </div>
    </form>
  </div>
</div>
{%- endmacro -%}

{% macro pagination(metadata, url_for_page) -%}
  <nav class="pagination is-small is-centered breathe-horizontal" role="navigation" aria-label="pagination">
    {% if metadata.current_page > 1 %}
    <a href="{{ url_for_page(metadata.current_page - 1, metadata.page_size) }}"
      class="pagination-previous">Previous
    </a>
    {% else %}
    <a href=""
      class="pagination-previous is-invisible">Previous
    </a>
    {% endif %}
    {% if metadata.current_page < metadata.total_pages %}
      <a href="{% if metadata.current_page + 1 <= metadata.max_pages %}{{ url_for_page(metadata.current_page + 1, metadata.page_size) }}{% endif %}"
        class="pagination-next" {% if metadata.current_page + 1 > metadata.max_pages %}disabled="true"{% endif %}>Next
      </a>
    {% else %}
    <a href=""
      class="pagination-next is-invisible">Next
    </a>
    {% endif %}
    <ul class="pagination-list">

      <li>
        <a href="{{ url_for_page(1, metadata.page_size) }}"
          class="pagination-link {% if metadata.current_page == 1 %}is-current{% endif %}"
          aria-label="Goto page 1">1
        </a>
      </li>

      {% if metadata.total_pages < 8 %}
        {% for p in range(2, metadata.total_pages + 1) %}
        <li>
          <a href="{{ url_for_page(p, metadata.page_size) }}"
            class="pagination-link {% if metadata.current_page == p %}is-current{% endif %}"
            aria-label="Page {{ p }}"
            aria-current="page">{{ p }}
          </a>
        </li>
        {% endfor %}
      {% else %}
        {% if metadata.current_page <= 3 %}                             {# Close to the start page #}
          {% for p in range(2, 6) %}
          <li>
            <a href="{{ url_for_page(p, metadata.page_size) }}"
              class="pagination-link {% if metadata.current_page == p %}is-current{% endif %}"
              aria-label="Page {{ p }}"
              aria-current="page">{{ p }}
            </a>
          </li>
          {% endfor %}
          <li><span class="pagination-ellipsis">&hellip;</span></li>
        {% elif (metadata.total_pages + 1 - metadata.current_page) <= 3 %}  {# Close to the end page #}
          <li><span class="pagination-ellipsis">&hellip;</span></li>
          {% for p in range(metadata.total_pages - 4, metadata.total_pages + 1) %}
          <li>
            <a href="{{ url_for_page(p, metadata.page_size) }}"
              class="pagination-link {% if metadata.current_page == p %}is-current{% endif %}"
              aria-label="Page {{ p }}"
              aria-current="page">{{ p }}
            </a>
          </li>
          {% endfor %}
        {% else %}                                                       {# Somewhere in the middle #}
          <li><span class="pagination-ellipsis">&hellip;</span></li>
          {% for p in range(metadata.current_page - 1, metadata.current_page + 2) %}
          {% if p <= metadata.max_pages %}
          <li>
            <a href="{{ url_for_page(p, metadata.page_size) }}"
              class="pagination-link {% if metadata.current_page == p %}is-current{% endif %}"
              aria-label="Page {{ p }}"
              aria-current="page">{{ p }}
            </a>
          </li>
          {% endif %}
          {% endfor %}
          <li><span class="pagination-ellipsis">&hellip;</span></li>
        {% endif %}
      {% endif %}
    </ul>
  </nav>
  {% if metadata.current_page + 1 > metadata.max_pages %}
  <p class="has-text-right has-text-grey is-size-7 breathe-horizontal">
    Only {{ metadata.max_pages }} pages are available. Please refine your search.
  </p>
  {% endif %}
{%- endmacro %}


{% macro search_results(form, results, metadata, external_url, url_for_page, url_for_author_search) %}

{% if metadata.total_pages > 1 %}
  {{ pagination(metadata, url_for_page) }}
{% endif %}

<ol class="breathe-horizontal" start="{{ metadata.start + 1}}"> {# Start index is 0-based. #}

{% for result in results %}
  <li class="arxiv-result">
    <div class="level is-marginless">
      <p class="list-title level-left">
        <a href="{{ external_url('browse', 'abstract', paper_id=result.paper_id_v) }}">arXiv:{{ result.paper_id_v }}</a>
        <span>&nbsp;{{ paper_format_links(result, external_url) }}&nbsp;</span>

        <span class="tag is-small is-link">{{ result.primary_classification.category.id }}</span>
        {% if result.secondary_category %}
          {% for secondary in result.secondary_category %}
            <span class="tag is-small is-grey">{{ secondary.archive }} {{ secondary.category }}</span>
          {% endfor %}
        {% endif -%}
        {% if not result.is_current %}<span class="has-text-grey is-size-7">Version {{ result.version }} of {{ result.latest_version }}</span>{% endif %}
      </p>
      {% if result.doi %}
      <div class="field is-grouped is-grouped-multiline level-right">
        {% for doi in result.doi %}
        <div class="control">
          <div class="tags has-addons">
            <span class="tag is-dark is-size-7">doi</span>
            <span class="tag is-light is-size-7"><a class="" href="https://dx.doi.org/{{ doi }}">{{ doi }} <i class="fa fa-external-link" aria-hidden="true"></i></a></span>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {# Note: mathjax class should be applied to any element that requires MathJax processing #}
    <p class="title is-5 mathjax">

      {% if result.highlight.title_utf8 %}
        {{ result.highlight.title_utf8 | safe }}
      {% else %}
        {% if result.highlight.title %}
          {{ result.highlight.title | safe }}
        {% else %}
          {{ result.title_utf8 }}
        {% endif %}
      {% endif %}
    </p>
    <p class="authors is-size-7">
      <span class="has-text-black-bis has-text-weight-semibold">Authors:</span>
      {% for author in result.authors[0:25] %}
      <a href="{{ url_for_author_search(author.first_name, author.last_name) }}">{{ author.first_name }} {{ author.last_name }}{% if author.suffix %} {{ author.suffix }}{%- endif -%}</a>{{ ", " if not loop.last }}
      {% endfor -%}
      {% if result.authors | length > 25 %}, et al. ({{ result.authors | length - 25 }} additional authors not shown){% endif %}
    </p>
    <p class="abstract mathjax  is-size-7">
      <span class="has-text-black-bis has-text-weight-semibold">Abstract</span>:
        <span class="abstract-short has-text-grey-dark mathjax" id="{{result.id}}-abstract-short" style="display: inline;">
          {{ result.preview.abstract | safe }}
          <a class="is-size-7" onclick="document.getElementById('{{result.id}}-abstract-full').style.display = 'inline'; document.getElementById('{{result.id}}-abstract-short').style.display = 'none';">&#9661; More</a>
        </span>
        <span class="abstract-full has-text-grey-dark mathjax" id="{{result.id}}-abstract-full" style="display: none;">
          {% if result.highlight.abstract %}{{ result.highlight.abstract | safe }}{% else %}{{ result.abstract }}{% endif %}
          <a class="is-size-7" onclick="document.getElementById('{{result.id}}-abstract-full').style.display = 'none'; document.getElementById('{{result.id}}-abstract-short').style.display = 'inline';">&#9651; Less</a>
        </span>
    </p>
    <p class="is-size-7"><span class="has-text-black-bis has-text-weight-semibold">Submitted</span> {{ result.submitted_date.strftime('%-d %B, %Y') }}; {% if result.version > 1 %}<span class="has-text-black-bis has-text-weight-semibold">v1</span> submitted {{ result.submitted_date_first.strftime('%-d %B, %Y') }};{% endif %} <span class="has-text-black-bis has-text-weight-semibold">originally announced</span> {{ result.announced_date_first.strftime('%B %Y') }}. {% if result.latest %}<span class="has-text-weight-bold">Latest version:</span> <a href="{{ external_url('browse', 'abstract', paper_id=result.latest) }}">{{ result.latest }}</a>.{% endif %}</p>

    {% if result.comments %}
    <p class="comments is-size-7">
      <span class="has-text-black-bis has-text-weight-semibold">Comments:</span>
      <span class="has-text-grey-dark mathjax">{% if result.highlight.comments %}{{ result.highlight.comments | safe }}{% else %}{{ result.comments }}{% endif %}</span>
    </p>
    {% endif %}

    {% if result.report_num %}
      <p class="comments is-size-7">
        <span class="has-text-black-bis has-text-weight-semibold">Report number:</span>
        {% if result.highlight.report_num %}{{ result.highlight.report_num | safe }}{% else %}{{ result.report_num }}{% endif %}
      </p>
    {% endif %}

    {% if result.journal_ref %}
      <p class="comments is-size-7">
        <span class="has-text-black-bis has-text-weight-semibold">Journal ref:</span>
        {% if result.highlight.journal_ref %}{{ result.highlight.journal_ref | safe }}{% else %}{{ result.journal_ref }}{% endif %}
      </p>
    {% endif %}
  </li>
{% endfor %}
</ol>

{% if metadata.total_pages > 1 %}
  {{ pagination(metadata, url_for_page) }}
{% endif %}

{%- endmacro -%}

{%- macro paper_format_links(result, external_url) -%}
  {%- for format in result.formats -%}
    {%- if format in ('pdf', 'pdfonly', 'ps', 'other') -%}
      {% if loop.first %}[{% endif %}<a href="{{ external_url('browse', format, paper_id=result.paper_id_v) }}">{{ format|replace("pdfonly", "pdf") }}</a>{% if not loop.last %}, {% else %}]{% endif %}
    {%- endif -%}
  {%- endfor -%}
{%- endmacro -%}
